name: Slack PR Comment Notification

on:
  push:
    branches:
      - '**'
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  discussion_comment:
    types: [created]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    # ÂØæË±°„Ç§„Éô„É≥„Éà„ÇíÊòéÁ§∫ÔºàPR„ÉªIssue„Éª„Ç≥„Éü„ÉÉ„Éà„Éª„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Ç≥„É°„É≥„ÉàÔºâ
    if: >
      github.event_name == 'issue_comment' ||
      github.event_name == 'pull_request_review_comment' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'push' ||
      github.event_name == 'discussion_comment'

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL is not set; skipping." >&2
            exit 0
          fi

          # „Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüÊÉÖÂ†±„ÇíÂèñÂæóÔºàPR/Issue/Commit/DiscussionÔºâ
          # NOTE: untrustedÊú¨Êñá„ÇíGitHubÂºèÂ±ïÈñã„Åß„Ç∑„Çß„É´„Å∏Áõ¥Êé•Âüã„ÇÅËæº„Åæ„Å™„ÅÑÔºà„ÇØ„Ç©„Éº„ÉàÂ¥©„Çå/Ê≥®ÂÖ•„ÅÆÊ∏©Â∫äÔºâ
          EVENT_JSON="${GITHUB_EVENT_PATH}"
          EVENT_NAME="${GITHUB_EVENT_NAME}"

          COMMENT_BODY=""
          COMMENT_URL=""
          COMMENTER=""
          TARGET_URL=""
          TITLE=""
          NUMBER=""
          COMMENT_TYPE=""

          if [ "${EVENT_NAME}" = "issue_comment" ]; then
            COMMENT_BODY="$(jq -r '.comment.body // ""' "$EVENT_JSON")"
            COMMENT_URL="$(jq -r '.comment.html_url // ""' "$EVENT_JSON")"
            COMMENTER="$(jq -r '.comment.user.login // ""' "$EVENT_JSON")"
            TARGET_URL="$(jq -r '.issue.html_url // ""' "$EVENT_JSON")"
            TITLE="$(jq -r '.issue.title // ""' "$EVENT_JSON")"
            NUMBER="$(jq -r '.issue.number // ""' "$EVENT_JSON")"
            COMMENT_TYPE="Issue„Ç≥„É°„É≥„Éà"
          elif [ "${EVENT_NAME}" = "pull_request_review_comment" ]; then
            COMMENT_BODY="$(jq -r '.comment.body // ""' "$EVENT_JSON")"
            COMMENT_URL="$(jq -r '.comment.html_url // ""' "$EVENT_JSON")"
            COMMENTER="$(jq -r '.comment.user.login // ""' "$EVENT_JSON")"
            TARGET_URL="$(jq -r '.pull_request.html_url // ""' "$EVENT_JSON")"
            TITLE="$(jq -r '.pull_request.title // ""' "$EVENT_JSON")"
            NUMBER="$(jq -r '.pull_request.number // ""' "$EVENT_JSON")"
            COMMENT_TYPE="„É¨„Éì„É•„Éº„Ç≥„É°„É≥„Éà"
          elif [ "${EVENT_NAME}" = "pull_request_review" ]; then
            COMMENT_BODY="$(jq -r '.review.body // ""' "$EVENT_JSON")"
            COMMENT_URL="$(jq -r '.review.html_url // ""' "$EVENT_JSON")"
            COMMENTER="$(jq -r '.review.user.login // ""' "$EVENT_JSON")"
            TARGET_URL="$(jq -r '.pull_request.html_url // ""' "$EVENT_JSON")"
            TITLE="$(jq -r '.pull_request.title // ""' "$EVENT_JSON")"
            NUMBER="$(jq -r '.pull_request.number // ""' "$EVENT_JSON")"
            COMMENT_TYPE="„É¨„Éì„É•„Éº"
          elif [ "${EVENT_NAME}" = "push" ]; then
            if [ "$(jq -r '.deleted // false' "$EVENT_JSON")" = "true" ]; then
              echo "push event is a branch deletion; skipping." >&2
              exit 0
            fi

            COMMENT_BODY="$(jq -r '.head_commit.message // ""' "$EVENT_JSON")"
            COMMENT_URL="$(jq -r '.compare // ""' "$EVENT_JSON")"
            COMMENTER="$(jq -r '.pusher.name // ""' "$EVENT_JSON")"
            REPO_HTML_URL="$(jq -r '.repository.html_url // ""' "$EVENT_JSON")"
            BRANCH_NAME="${GITHUB_REF_NAME:-${GITHUB_REF#refs/heads/}}"
            TARGET_URL="$REPO_HTML_URL/tree/$BRANCH_NAME"
            TITLE="Push to $BRANCH_NAME"
            NUMBER=""
            COMMENT_TYPE="Push"
          elif [ "${EVENT_NAME}" = "discussion_comment" ]; then
            COMMENT_BODY="$(jq -r '.comment.body // ""' "$EVENT_JSON")"
            COMMENT_URL="$(jq -r '.comment.html_url // ""' "$EVENT_JSON")"
            COMMENTER="$(jq -r '.comment.user.login // ""' "$EVENT_JSON")"
            TARGET_URL="$(jq -r '.discussion.html_url // ""' "$EVENT_JSON")"
            TITLE="$(jq -r '.discussion.title // ""' "$EVENT_JSON")"
            NUMBER="$(jq -r '.discussion.number // ""' "$EVENT_JSON")"
            COMMENT_TYPE="„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Ç≥„É°„É≥„Éà"
          fi

          # „Ç≥„É°„É≥„ÉàÊú¨Êñá„Éó„É¨„Éì„É•„ÉºÊï¥ÂΩ¢
          if [ -z "${COMMENT_BODY}" ]; then
            COMMENT_PREVIEW="(Êú¨Êñá„Å™„Åó)"
          elif [ ${#COMMENT_BODY} -gt 100 ]; then
            COMMENT_PREVIEW="${COMMENT_BODY:0:100}..."
          else
            COMMENT_PREVIEW="${COMMENT_BODY}"
          fi

          # Ë°®Á§∫Áî®„Çø„Ç§„Éà„É´ÔºàÁï™Âè∑„Åå„ÅÇ„Çå„Å∞‰ªò‰∏éÔºâ ‚Äî YAMLÂÜÖ„ÅßË§áÈõë„Å™Â±ïÈñã„ÇíÈÅø„Åë„Çã
          if [ -n "${NUMBER}" ]; then
            DISPLAY_TITLE="#${NUMBER} ${TITLE}"
          else
            DISPLAY_TITLE="${TITLE}"
          fi

          # SlackÈÄöÁü•„ÅÆ„Éö„Ç§„É≠„Éº„Éâ„Çí‰ΩúÊàêÔºàJSON„Ç®„Çπ„Ç±„Éº„Éó„Çíjq„Å´‰ªª„Åõ„ÇãÔºâ
          PAYLOAD=$(jq -n \
            --arg comment_type "${COMMENT_TYPE}" \
            --arg target_url "${TARGET_URL}" \
            --arg display_title "${DISPLAY_TITLE}" \
            --arg commenter "${COMMENTER}" \
            --arg comment_preview "${COMMENT_PREVIEW}" \
            --arg comment_url "${COMMENT_URL}" \
            '{
              text: "„Ç≥„É°„É≥„Éà„ÅåÊäïÁ®ø„Åï„Çå„Åæ„Åó„Åü",
              blocks: [
                {
                  type: "header",
                  text: { type: "plain_text", text: ("üí¨ Êñ∞„Åó„ÅÑ" + $comment_type) }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: ("*ÂØæË±°:*\n<" + $target_url + "|" + $display_title + ">") },
                    { type: "mrkdwn", text: ("*ÊäïÁ®øËÄÖ:*\n" + $commenter) }
                  ]
                },
                {
                  type: "section",
                  text: { type: "mrkdwn", text: ("*„Ç≥„É°„É≥„Éà:*\n" + $comment_preview) }
                },
                {
                  type: "actions",
                  elements: [
                    {
                      type: "button",
                      text: { type: "plain_text", text: "„Ç≥„É°„É≥„Éà„ÇíË¶ã„Çã" },
                      url: $comment_url
                    }
                  ]
                }
              ]
            }')

          # Slack Webhook„Å´ÈÄÅ‰ø°
          curl --fail-with-body -sS -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
